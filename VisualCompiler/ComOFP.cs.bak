using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Windows.Forms;


namespace VisualCompiler
{
    class ComOFP
    {
        // Since this component only uses the framework to send messages to
        // the remote OFP app (App2) it has no queue to deliver messages to
        // this app of App1.
        //
        // It contains only two topics.  To send the created table and, when
        // in OFP mode, to send the selected CDU key along with the currently
        // displayed page to the remote OFP app.

        static private Component.ParticipantKey componentKey;

        static private Topic.TopicIdType changePageTopic;
        static private Topic.TopicIdType keyPushTopic;

        static private Disburse queue;

        static private CDUForm cduForm = new CDUForm();

        static public bool connected = false; // connected to remote app 2

        static private bool responseReceived = false;
        static private CDUForm.Result response = new CDUForm.Result();
        static private string receivedPageChange = "";

        static public void Install()
        {
            // Create Disburse queue
            queue = new Disburse("ComOFP", true, // use Timer event wakeup
                                 false, AnyMessage); // not periodic

            // Register this component
            Component.RegisterResult result;
            result = Component.Register
                     ("ComOFP", 0, Threads.ComponentThreadPriority.NORMAL, 
                      MainEntry, queue);
            componentKey = result.key;

            if (result.status == Component.ComponentStatus.VALID)
            {
                Library.AddStatus status;

                changePageTopic.topic = Topic.Id.OFP;
                changePageTopic.ext = Topic.Extender.CHANGEPAGE;
                keyPushTopic.topic = Topic.Id.OFP;
                keyPushTopic.ext = Topic.Extender.KEYPUSH;

                // Register to consume the OFP CHANGEPAGE topic
                status = Library.RegisterTopic
                         (changePageTopic, result.key,
                          Delivery.Distribution.CONSUMER, MainEntry);

                // Register to produce the OFP KEYPUSH topic
                status = Library.RegisterTopic
                         (keyPushTopic, result.key,
                          Delivery.Distribution.PRODUCER, null);
            }

        } // end Install

        // Entry point
        static void MainEntry()
        {
            while (true) // loop forever
            {
                if (connected)
                {
                    // Wait for event.
                    string xxx = queue.queueName;
                    queue.EventWait();
                }
                // wait for remote app (remoteAppId of 2) before wait for event
                else if ((!connected) && (Remote.RegisterAcknowledged(2)))
                {
                    var result = MessageBox.Show("Ok to use keys", "TreatKey",
                                                 MessageBoxButtons.OK);

                    connected = true;
                }
                else
                {
                    Thread.Sleep(100); // wait and check for connected
                }

            } // end forever loop

        } // end MainEntry

        static void AnyMessage(Delivery.MessageType message)
        {
            // Treat received message
            ConsoleOut.WriteLine("ComOFP AnyMessage " + message.data);
       //     cduForm.DisplayPageTitle(message.data);
            receivedPageChange = message.data;
    //        var result = MessageBox.Show("received " + message.data, 
    //                                     "ChangePage", MessageBoxButtons.OK );
            responseReceived = true;

        } // end AnyMessage

 //       const string message =
 //       "Are you sure that you would like to close the form?";
 //       const string caption = "Form Closing";
 //       var result = MessageBox.Show(message, caption,
 //       MessageBoxButtons.YesNo,
 //       MessageBoxIcon.Question);

        public CDUForm.Result TreatKey(CDUForm.Key key)
        {
            responseReceived = false;

  //          var result = MessageBox.Show("key " + key.ToString(),
  //                                       "TreatKey", MessageBoxButtons.OK);

            Delivery.MessageType keypush;
 //           keypush.header.CRC = 0;
 //           keypush.header.id.topic = Topic.Id.OFP;
 //           keypush.header.id.ext = Topic.Extender.KEYPUSH;
 //           keypush.header.from = Component.nullKey;
 //           keypush.header.from.appId = App.applicationId;
 //           keypush.header.to = Component.nullKey;
 //           keypush.header.to.appId = 2; //?? what for App2
 //           keypush.header.referenceNumber = 0;
            keypush.data = key.ToString();
 //           keypush.header.size = (short)keypush.data.Length;
 //           Delivery.Publish(keypush.header.to.appId, keypush);
     //       Topic keyTopic;
     //       keyTopic.id = Topic.Id.OFP;
     //       keyTopic.ext = Topic.Extender.KEYPUSH;
            Delivery.Publish(keyPushTopic, componentKey, keypush.data); //.ToString);

            //>>> add a timeout to return false
            // Wait until response received
            while (true)
            {
                if (!responseReceived)
                {
                    Thread.Sleep(100); // millisecs
                }
                else
                {
                    break; // exit loop
                }
            }
            // Return the response
            responseReceived = false;
            response.success = true;
            response.text = receivedPageChange;
            return response;

        } // end TreatKey

    }
}
